name: Update AUR Package

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-natmap:
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel

    steps:
      - name: Install Dependencies
        run: |
          pacman -Syu --noconfirm git openssh

      - name: Setup Builder User
        run: |
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

      - name: Configure SSH
        env:
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
        run: |
          mkdir -p /root/.ssh
          eval $(ssh-agent -s)
          echo "$AUR_SSH_KEY" > /root/.ssh/aur_key
          chmod 600 /root/.ssh/aur_key
          echo "Host aur.archlinux.org" >> /root/.ssh/config
          echo "  IdentityFile /root/.ssh/aur_key" >> /root/.ssh/config
          echo "  User aur" >> /root/.ssh/config
          ssh-keyscan aur.archlinux.org >> /root/.ssh/known_hosts
          
          # 复制 SSH 配置给 builder (以此支持 makepkg 拉取 git 源码)
          cp -r /root/.ssh /home/builder/.ssh
          chown -R builder:builder /home/builder/.ssh

      - name: Clone AUR Repository
        run: |
          git clone ssh://aur@aur.archlinux.org/natmap-git.git workspace
          chown -R builder:builder workspace

      - name: Update and Push
        working-directory: ./workspace
        run: |
          # 1. 配置 Git 提交人信息
          git config --global user.name "${{ secrets.AUR_USERNAME }}"
          git config --global user.email "${{ secrets.AUR_EMAIL }}"
          git config --global --add safe.directory $(pwd)

          echo "Starting update process..."

          # 2. 运行 makepkg
          # --nobuild: 不编译，只下载源文件
          # 关键点：makepkg 会自动执行 PKGBUILD 中的 pkgver() 函数
          # 并直接修改 PKGBUILD 文件中的 pkgver 变量值
          su builder -c "makepkg --nobuild"

          # 3. 重新生成 .SRCINFO
          # 因为 PKGBUILD 已经被上一步修改了，这里生成的 SRCINFO 也是最新的
          su builder -c "makepkg --printsrcinfo > .SRCINFO"

          # 4. 利用 Git 检测变化
          # git diff --exit-code 在没有变化时返回 0，有变化时返回 1
          # 我们使用 ! 取反：如果有变化则执行代码块
          if ! git diff --exit-code PKGBUILD .SRCINFO; then
            echo "Changes detected."
            
            # 读取新版本号用于 Commit 信息
            # 此时 PKGBUILD 已经是被 makepkg 修改过的新文件
            NEW_VER=$(grep "^pkgver=" PKGBUILD | cut -d= -f2)
            
            # 提交并推送
            git add PKGBUILD .SRCINFO
            git commit -m "upgpkg: natmap-git $NEW_VER"
            
            echo "Pushing to AUR..."
            git push origin master
          else
            echo "No changes detected in PKGBUILD or .SRCINFO. Nothing to do."
          fi
