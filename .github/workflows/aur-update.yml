name: Update AUR Package

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  update-aur:
    runs-on: ubuntu-latest
    container: archlinux:base-devel

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Dependencies
        run: |
          pacman -Syu --noconfirm git openssh fakeroot

          git config --global --add safe.directory "$GITHUB_WORKSPACE"

      # ✨ 不需要手动计算 pkgver，交给 makepkg
      - name: Run makepkg to update pkgver and .SRCINFO
        id: update
        run: |
          # makepkg 不允许用 root，因此创建 builder（若已经存在则忽略）
          id -u builder &>/dev/null || useradd -m builder
          chown -R builder:builder .

          # 让 builder 运行 makepkg（生成新 pkgver 和 .SRCINFO）
          su builder -c "
            cd $PWD
            makepkg --nobuild --noprepare --nodeps --nosign --nocheck
            makepkg --printsrcinfo > .SRCINFO
          "

          # 比较 pkgver 是否变化
          OLD_VER=$(git show HEAD:PKGBUILD | grep '^pkgver=' | cut -d= -f2)
          NEW_VER=$(grep '^pkgver=' PKGBUILD | cut -d= -f2)

          echo \"Old: $OLD_VER\"
          echo \"New: $NEW_VER\"

          if [ \"$OLD_VER\" != \"$NEW_VER\" ]; then
            echo \"UPDATED=true\" >> $GITHUB_OUTPUT
          else
            echo \"UPDATED=false\" >> $GITHUB_OUTPUT
          fi

      - name: Setup SSH
        if: steps.update.outputs.UPDATED == 'true'
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AUR_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan aur.archlinux.org >> ~/.ssh/known_hosts

      - name: Push to AUR
        if: steps.update.outputs.UPDATED == 'true'
        run: |
          git config --global user.name "${{ secrets.AUR_USERNAME }}"
          git config --global user.email "${{ secrets.AUR_EMAIL }}"

          git clone ssh://aur@aur.archlinux.org/natmap-git.git aur-repo
          cp PKGBUILD .SRCINFO aur-repo/

          cd aur-repo

          git add PKGBUILD .SRCINFO
          git commit -m "Update to version $(grep '^pkgver=' PKGBUILD | cut -d= -f2)"
          git push

      - name: Commit back to GitHub
        if: steps.update.outputs.UPDATED == 'true'
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add PKGBUILD .SRCINFO
          git commit -m "Auto update pkgver"
          git push
