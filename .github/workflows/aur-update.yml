name: Update AUR Package

on:
  # 定时触发：每天 UTC 时间 0点 (北京时间 8点)
  schedule:
    - cron: '0 0 * * *'
  # 允许手动触发
  workflow_dispatch:

jobs:
  update-aur:
    runs-on: ubuntu-latest
    # 使用 Arch Linux 容器，包含构建工具
    container: archlinux:base-devel

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Dependencies
        run: |
          # 更新系统并安装 git (makepkg 需要)
          pacman -Syu --noconfirm git openssh

          # 修复 git 安全目录问题
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Prepare Builder User
        # makepkg 不允许以 root 运行，我们需要创建一个 builder 用户
        run: |
          useradd -m builder
          chown -R builder:builder .
          # 给予 builder 用户无密码 sudo 权限 (如果构建过程中需要安装依赖)
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

      - name: Update pkgver and .SRCINFO
        id: update
        run: |
          # 1. 修改当前目录权限，确保 builder 可以读写
          chown -R builder:builder .

          # 2. 切换到 builder 用户执行，并将当前路径($PWD)作为参数传递($1)
          # 使用 'EOF' (带单引号) 防止外部 Shell 提前解析变量，保留给内部脚本处理
          su builder -c "bash -e -s" << 'EOF' -- "$PWD"
            BUILD_DIR="$1"
            
            # 进入工作目录
            cd "$BUILD_DIR"
            
            # 【重要】告诉 git 这是一个安全目录，否则操作 git 会报错
            git config --global --add safe.directory "$BUILD_DIR"

            # --- 下面是核心逻辑 ---

            # 下载源文件 (只会克隆 git 仓库到 src/ 目录)
            makepkg --nobuild --source

            # 加载 PKGBUILD 变量
            source PKGBUILD
            
            # 进入源码目录获取版本号
            # 注意：makepkg 会根据 source 数组中的 "pkgname::git+..." 将代码克隆到 src/pkgname
            if [ -d "src/$pkgname" ]; then
              cd "src/$pkgname"
            else
              echo "Error: Source directory src/$pkgname not found."
              exit 1
            fi
            
            # 提取新版本号
            NEW_VER=$(git describe --long --tags | sed 's/^v//;s/-/r/;s/-/./g')
            echo "Latest version from git: $NEW_VER"
            
            # 回到 PKGBUILD 所在目录
            cd "$BUILD_DIR"

            # 读取旧版本号
            OLD_VER=$(grep "^pkgver=" PKGBUILD | cut -d'=' -f2)
            
            if [ "$OLD_VER" != "$NEW_VER" ]; then
              # 更新 PKGBUILD
              sed -i "s/^pkgver=.*/pkgver=$NEW_VER/" PKGBUILD
              echo "Updated pkgver from $OLD_VER to $NEW_VER"
              
              # 更新 .SRCINFO
              makepkg --printsrcinfo > .SRCINFO
              
              # 创建一个标记文件，告诉外部脚本发生了更新
              # (因为 builder 用户可能无法直接写入 GITHUB_OUTPUT)
              touch .aur_updated
            else
              echo "Version has not changed."
            fi
          EOF

          # 3. 回到 root 上下文，检查标记文件并设置 Output
          if [ -f .aur_updated ]; then
            echo "UPDATED=true" >> $GITHUB_OUTPUT
            rm .aur_updated
          else
            echo "UPDATED=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup SSH
        if: steps.update.outputs.UPDATED == 'true'
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AUR_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          # 添加 AUR 的 host key 到 known_hosts
          ssh-keyscan aur.archlinux.org >> ~/.ssh/known_hosts

      - name: Push to AUR
        if: steps.update.outputs.UPDATED == 'true'
        run: |
          # 配置 git 信息
          git config --global user.name "${{ secrets.AUR_USERNAME || 'github-actions' }}"
          git config --global user.email "${{ secrets.AUR_EMAIL || 'github-actions@github.com' }}"

          # 克隆 AUR 仓库
          # 注意：这里的仓库名必须和你的包名一致
          git clone "ssh://aur@aur.archlinux.org/natmap-git.git" aur-repo

          # 复制更新后的文件到 AUR 仓库目录
          cp PKGBUILD .SRCINFO aur-repo/

          # 提交并推送
          cd aur-repo
          if [[ -n $(git status -s) ]]; then
            git add PKGBUILD .SRCINFO
            git commit -m "Update to version $(grep '^pkgver=' PKGBUILD | cut -d'=' -f2)"
            git push origin master
            echo "Successfully pushed to AUR."
          else
            echo "No changes to commit."
          fi
          
      - name: Commit back to GitHub (Optional)
        if: steps.update.outputs.UPDATED == 'true'
        run: |
          # 如果你也想把更新后的 PKGBUILD 同步回当前的 GitHub 仓库
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add PKGBUILD .SRCINFO
          git commit -m "Auto update pkgver" || echo "Nothing to commit"
          git push
