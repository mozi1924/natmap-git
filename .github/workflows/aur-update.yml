name: Update AUR Package

on:
  schedule:
    # 每天国际标准时间 0点 (北京时间 8点) 运行一次
    - cron: '0 0 * * *'
  workflow_dispatch: # 允许手动触发

jobs:
  update-natmap:
    runs-on: ubuntu-latest
    # 使用 Arch Linux 容器，包含了 makepkg 等必要工具
    container:
      image: archlinux:base-devel

    steps:
      - name: Install Dependencies
        run: |
          # 更新系统并安装 git 和 openssh
          pacman -Syu --noconfirm git openssh

      - name: Setup Builder User
        # makepkg 不允许以 root 运行，我们需要创建一个 builder 用户
        run: |
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

      - name: Configure SSH
        env:
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
        run: |
          mkdir -p /root/.ssh
          # 启动 ssh-agent 并添加密钥
          eval $(ssh-agent -s)
          echo "$AUR_SSH_KEY" > /root/.ssh/aur_key
          chmod 600 /root/.ssh/aur_key
          
          # 配置 SSH 使用该密钥访问 AUR
          echo "Host aur.archlinux.org" >> /root/.ssh/config
          echo "  IdentityFile /root/.ssh/aur_key" >> /root/.ssh/config
          echo "  User aur" >> /root/.ssh/config
          
          # 添加 AUR 的主机指纹
          ssh-keyscan aur.archlinux.org >> /root/.ssh/known_hosts
          
          # 复制 SSH配置给 builder 用户 (因为后续部分操作可能需要)
          cp -r /root/.ssh /home/builder/.ssh
          chown -R builder:builder /home/builder/.ssh

      - name: Clone AUR Repository
        run: |
          # 克隆 AUR 仓库
          git clone ssh://aur@aur.archlinux.org/natmap-git.git workspace
          # 将工作目录权限移交给 builder 用户
          chown -R builder:builder workspace

      - name: Update PKGBUILD and .SRCINFO
        working-directory: ./workspace
        run: |
          # 配置 git 信息
          git config --global user.name "${{ secrets.AUR_USERNAME }}"
          git config --global user.email "${{ secrets.AUR_EMAIL }}"
          
          # 标记目录安全以允许 builder 操作
          git config --global --add safe.directory $(pwd)

          echo "Fetching upstream changes..."
          # 切换到 builder 用户运行 makepkg
          # --nobuild: 仅下载源文件并解压，不编译
          # 这会触发 git clone https://github.com/heiher/natmap 到 src/natmap
          su builder -c "makepkg --nobuild --source"

          echo "Calculating new version..."
          # 进入源码目录，利用 git describe 获取最新版本号
          # 注意：这里的路径 src/natmap-git 对应 PKGBUILD 中的 source 命名
          cd src/natmap-git
          
          # 执行 PKGBUILD 中定义的 pkgver() 逻辑
          NEW_VER=$(git describe --long --tags | sed 's/^v//;s/-/r/;s/-/./g')
          echo "New version detected: $NEW_VER"
          
          # 回到 PKGBUILD 所在目录
          cd ../..
          
          # 获取旧版本号用于对比
          OLD_VER=$(grep "^pkgver=" PKGBUILD | cut -d= -f2)
          
          if [ "$NEW_VER" == "$OLD_VER" ]; then
            echo "Version has not changed. Exiting."
            echo "UPDATED=false" >> $GITHUB_ENV
            exit 0
          fi
          
          echo "Updating PKGBUILD..."
          # 使用 sed 更新 PKGBUILD 中的 pkgver
          sed -i "s/^pkgver=.*/pkgver=$NEW_VER/" PKGBUILD
          
          # 更新 pkgrel (通常版本号变了，rel 重置为 1)
          sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD

          echo "Generating .SRCINFO..."
          # 重新生成 .SRCINFO
          su builder -c "makepkg --printsrcinfo > .SRCINFO"
          
          echo "UPDATED=true" >> $GITHUB_ENV

      - name: Push to AUR
        working-directory: ./workspace
        if: env.UPDATED == 'true'
        run: |
          # 再次配置 git (以防环境切换丢失)
          git config user.name "${{ secrets.AUR_USERNAME }}"
          git config user.email "${{ secrets.AUR_EMAIL }}"
          
          NEW_VER=$(grep "^pkgver=" PKGBUILD | cut -d= -f2)
          
          git add PKGBUILD .SRCINFO
          git commit -m "upgpkg: natmap-git $NEW_VER"
          
          echo "Pushing changes to AUR..."
          # 这里需要指明私钥，或者确保之前 SSH 配置对当前环境生效
          # 由于我们在 root 下运行 git push，使用的是 /root/.ssh/config
          git push origin master
